---
layout: post
comments: true
title: "Invoking .NET from Ruby"
---

# Invoking .NET from Ruby

## Why I do it

From time to time you may find yourself with the need to call into .NET from Ruby. Personally, I find myself doing so in my automation test 
suites for .NET applications that we drive using `cucumber` and [`mohawk`](https://github.com/leviwilson/mohawk). 
Generally I do so in either some setup or cleanup hooks with `cucumber` if I need to do something outside of the UI. [`RAutomation`](https://github.com/jarmo/RAutomation) 
itself (the underlying driver for `mohawk`) makes use of this technique to hook into [Microsoft UI Automation](http://msdn.microsoft.com/en-us/library/ms747327.aspx) 
to drive Windows applications from ruby. In this post I will go over the way in which we can set this up.

## Moving Parts

There are a couple of manners in which you can achieve this. One is using something like [`IronRuby`](https://ironruby.codeplex.com/), which is a .NET implementation of the 
ruby programming language, but this seemed like overkill for my needs. Additionally, development on IronRuby seems to have been non-existent for a few years and there are limitations as to what version of ruby that you can use with it.

Another manner is to use a Managed C++ DLL as a wrapper and calling into it using the [`Ruby-FFI`](https://github.com/ffi/ffi) gem. This is the technique that we will be discussing in this article.

## The Wrapper

### Creating the Project

The managed C++ DLL is used to interface with ruby. To get your basic "Hello World" project setup, simply use Visual Studio to create a new C++ -> CLR project.

![C++ .NET CLR Project](/images/dotnet_new_project.png)

This will generate a C++ CLR library project that looks like the following:

```
.
│   .gitattributes
│   .gitignore
│   Hello.Net.FromRuby.sln
│
└───Hello.Net.FromRuby
        app.ico
        app.rc
        AssemblyInfo.cpp
        Hello.Net.FromRuby.cpp
        Hello.Net.FromRuby.h
        Hello.Net.FromRuby.vcxproj
        Hello.Net.FromRuby.vcxproj.filters
        ReadMe.txt
        resource.h
        Stdafx.cpp
        Stdafx.h
```

By default, this will create a manged C++ library project with nothing in the `Hello.Net.FromRuby.h` and `Hello.Net.FromRuby.cpp` with a managed class definition in it.

### Hello World

To get our "Hello, world!" application rolling, we simply need to export a method that we will be able to call from ruby. Modify the `.h` and `.cpp` files to look like the following:

```c++
// Hello.Net.FromRuby.h
#pragma once

using namespace System;

extern "C" {
  _declspec(dllexport) void Hello_DotNet_FromRuby(const char* message);
}
```

```c++
// Hello.Net.FromRuby.cpp
#include "stdafx.h"

#include "Hello.Net.FromRuby.h"

void Hello_DotNet_FromRuby(const char* toWhom) {
  Console::WriteLine("Hello, {0}!", gcnew String(toWhom));
}
```

In order to call into our exported method from ruby, we will need to setup `ffi` like the following:

```ruby
# hello_dotnet_fromruby.rb
require 'ffi'

module Library
  extend FFI::Library

  ffi_lib File.join(File.dirname(__FILE__), 'Debug/Hello.Net.FromRuby.dll')

  attach_function :hello, :Hello_DotNet_FromRuby, [:string], :void
end
```

After you've saved `hello_dotnet_fromruby.rb` you can run it in `irb` like so:

```
>> irb
irb(main):001:0> load 'hello_dotnet_fromruby.rb'
=> true
irb(main):002:0> Library.hello 'World'
Hello, World!
=> nil
irb(main):003:0>
```

And BAM! We are calling `Console::WriteLine` from ruby. Wasn't that simple?

## C++ Runtime Dependency
If you are trying to run this on another machine, you may have seen the following error message when you tried to load the file:

```
irb(main):002:0> load 'hello_dotnet_fromruby.rb'
LoadError: Could not open library './Debug/Hello.Net.FromRuby.dll': The specified module could not be found.

        from C:/Ruby193/lib/ruby/gems/1.9.1/gems/ffi-1.9.0-x86-mingw32/lib/ffi/library.rb:123:in `block in ffi_lib'
        from C:/Ruby193/lib/ruby/gems/1.9.1/gems/ffi-1.9.0-x86-mingw32/lib/ffi/library.rb:90:in `map'
        from C:/Ruby193/lib/ruby/gems/1.9.1/gems/ffi-1.9.0-x86-mingw32/lib/ffi/library.rb:90:in `ffi_lib'
        from hello_dotnet_fromruby.rb:6:in `<module:Library>'
        from hello_dotnet_fromruby.rb:3:in `<top (required)>'
        from (irb):2:in `load'
        from (irb):2
        from C:/Ruby193/bin/irb:12:in `<main>'
irb(main):003:0>
```

One of two things can be causing this. Either the actual path to the `Hello.Net.FromRuby.dll` is not actually there, or the machine that you're running this on does not have the Microsoft C++ Runtime installed. If you built the DLL with Visual Studio 2012, you will need the [C++ 2012 Runtime Redistributable](http://www.microsoft.com/en-us/download/details.aspx?id=30679), if you built it with Visual Studio 2010 you will need the [C++ 2012 Runtime Redistributable](http://www.microsoft.com/en-us/download/details.aspx?id=5555) installed.

## FFI Tips & Tricks

### Unit Testing / Memory

